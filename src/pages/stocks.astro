---
import Layout from '../layouts/MainLayout.astro';
---

<Layout>
  <div class="bg-white p-6 md:p-8 rounded-lg shadow-lg">
    <h2 class="text-3xl font-bold text-gray-800 mb-2">Portfolio Simulator</h2>
    <p class="text-gray-600 mb-6">Build a portfolio of stocks and simulate its performance over the last week.</p>

    <!-- API Key Section -->
    <div class="bg-gray-50 p-4 rounded-lg border mb-6">
      <h3 class="text-lg font-semibold text-gray-800 mb-2">1. Enter Your API Key</h3>
      <p class="text-sm text-gray-600 mb-3">
        This tool uses the Alpha Vantage API to get stock data. Please provide your own free API key to continue.
      </p>
      <div class="flex items-center space-x-2">
        <input type="text" id="api-key" placeholder="Your Alpha Vantage API Key" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-hbs-crimson focus:border-hbs-crimson sm:text-sm">
        <a href="https://www.alphavantage.co/support/#api-key" target="_blank" class="text-sm text-hbs-crimson hover:underline whitespace-nowrap">Get a Free Key</a>
      </div>
       <p class="text-xs text-gray-500 mt-2">Your key will be stored in your browser's local storage for convenience.</p>
    </div>

    <!-- Portfolio Builder Section -->
    <div class="pt-4">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">2. Build Your Portfolio</h3>
        <datalist id="popular-stocks">
          <!-- Populated by JS -->
        </datalist>
        <form id="portfolio-form" class="space-y-4">
            <div id="stock-list" class="space-y-4">
                <!-- Stock rows will be dynamically inserted here -->
            </div>
            <div class="flex items-center space-x-4">
              <button type="button" id="add-stock" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md text-sm">
                  + Add Stock
              </button>
              <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-hbs-crimson hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-hbs-crimson">
                  Calculate Performance
              </button>
            </div>
             <p class="text-xs text-gray-500 mt-2">Note: Performance is calculated based on daily returns over the last 30 trading days.</p>
        </form>
    </div>

    <!-- Results Section -->
    <div id="results" class="mt-8"></div>

    <!-- Chart Section -->
    <div class="mt-8 bg-gray-50 p-4 rounded-lg border" style="display:none;" id="chart-container">
        <h3 class="text-xl font-bold text-gray-800 mb-4">Efficient Frontier Visualization</h3>
        <div class="relative h-96 w-full">
            <canvas id="frontier-chart"></canvas>
        </div>
        <p class="text-sm text-gray-500 mt-2">Plot of Estimated Annual Return vs. Annualized Volatility for each calculated portfolio.</p>
    </div>
  </div>

  <!-- Load Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    import { POPULAR_STOCKS } from '../data/stocks.js';

    document.addEventListener('DOMContentLoaded', () => {
        const apiKeyInput = document.getElementById('api-key') as HTMLInputElement;
        const addStockBtn = document.getElementById('add-stock');
        const stockListDiv = document.getElementById('stock-list');
        const portfolioForm = document.getElementById('portfolio-form');
        const resultsDiv = document.getElementById('results');
        const popularStocksDatalist = document.getElementById('popular-stocks');
        const chartContainer = document.getElementById('chart-container');
        const ctx = document.getElementById('frontier-chart') as HTMLCanvasElement;

        // Chart initialization
        let frontierChart = null;

        function initChart() {
            if (frontierChart) return;

            // Check if Chart is loaded
            if (typeof Chart === 'undefined') {
                console.error('Chart.js not loaded');
                return;
            }

            frontierChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Portfolios',
                        data: [], // {x: volatility, y: return, composition: []}
                        backgroundColor: 'rgba(164, 16, 52, 0.6)', // HBS Crimson with opacity
                        borderColor: 'rgba(164, 16, 52, 1)',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Annualized Volatility (%)'
                            },
                            beginAtZero: true
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Estimated Annual Return (%)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    const returnVal = point.y.toFixed(2);
                                    const volVal = point.x.toFixed(2);
                                    return `Return: ${returnVal}%, Volatility: ${volVal}%`;
                                },
                                afterBody: function(context) {
                                    const point = context[0].raw;
                                    if (point.composition) {
                                        return ['Composition:', ...point.composition.map(s => ` ${s.ticker}: ${s.weight}%`)];
                                    }
                                    return [];
                                }
                            }
                        }
                    }
                }
            });
        }


        // Populate datalist
        POPULAR_STOCKS.forEach(stock => {
            const option = document.createElement('option');
            option.value = stock.symbol;
            option.textContent = `${stock.symbol} - ${stock.name}`;
            popularStocksDatalist.appendChild(option);
        });

        // Load API key from local storage
        apiKeyInput.value = localStorage.getItem('alphaVantageApiKey') || '';

        // Save API key to local storage on change
        apiKeyInput.addEventListener('change', () => {
            localStorage.setItem('alphaVantageApiKey', apiKeyInput.value);
        });

        const addStockRow = () => {
            const stockId = Date.now();
            const stockRow = document.createElement('div');
            stockRow.classList.add('flex', 'items-center', 'space-x-3', 'p-2', 'bg-white', 'rounded-md', 'border');
            stockRow.setAttribute('data-id', stockId.toString());

            stockRow.innerHTML = `
                <div class="flex-grow">
                    <label for="ticker-${stockId}" class="sr-only">Ticker</label>
                    <input type="text" id="ticker-${stockId}" name="ticker" list="popular-stocks" placeholder="e.g., AAPL" class="w-full border-gray-300 rounded-md shadow-sm sm:text-sm" required>
                </div>
                <div class="flex-grow">
                    <label for="weight-${stockId}" class="sr-only">Weight</label>
                    <input type="range" id="weight-${stockId}" name="weight-slider" min="1" max="100" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
                <div class="w-20 text-center">
                    <label for="weight-input-${stockId}" class="sr-only">Weight Input</label>
                    <input type="number" id="weight-input-${stockId}" name="weight" min="1" max="100" value="50" class="w-full text-center border-gray-300 rounded-md shadow-sm sm:text-sm p-1">
                </div>
                <button type="button" class="text-red-500 hover:text-red-700 font-bold remove-stock">&times;</button>
            `;

            stockListDiv.appendChild(stockRow);

            // Sync slider and number input
            const weightSlider = stockRow.querySelector(`input[name="weight-slider"]`) as HTMLInputElement;
            const weightInput = stockRow.querySelector(`input[name="weight"]`) as HTMLInputElement;

            weightSlider.addEventListener('input', () => {
                weightInput.value = weightSlider.value;
            });

            weightInput.addEventListener('input', () => {
                weightSlider.value = weightInput.value;
            });

            // Add event listener for the remove button
            const removeButton = stockRow.querySelector('.remove-stock');
            removeButton.addEventListener('click', () => {
                stockRow.remove();
            });
        };

        addStockBtn.addEventListener('click', addStockRow);
        // Add one stock row by default
        addStockRow();


        portfolioForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                resultsDiv.innerHTML = '<p class="text-red-500">Please enter your Alpha Vantage API key.</p>';
                return;
            }

            const stocks = Array.from(stockListDiv.children).map(row => {
                const tickerInput = row.querySelector('input[name="ticker"]') as HTMLInputElement;
                const weightInput = row.querySelector('input[name="weight"]') as HTMLInputElement;
                return {
                    ticker: tickerInput.value.toUpperCase(),
                    weight: parseFloat(weightInput.value)
                };
            });

            if (stocks.some(s => !s.ticker)) {
                 resultsDiv.innerHTML = '<p class="text-red-500">Please enter a ticker for all stocks.</p>';
                return;
            }

            if (stocks.some(s => isNaN(s.weight) || s.weight <= 0)) {
                resultsDiv.innerHTML = '<p class="text-red-500">Please enter a valid weight > 0 for all stocks.</p>';
                return;
            }

            resultsDiv.innerHTML = '<p class="text-gray-600">Calculating portfolio performance... (This may take a moment)</p>';

            try {
                // Fetch data for all stocks
                // Using 30 days of data for volatility calculation
                const promises = stocks.map(stock => fetchData(stock.ticker, apiKey));
                const results = await Promise.all(promises);

                let totalWeight = stocks.reduce((sum, s) => sum + s.weight, 0);

                // Process results
                let validResults = [];
                let hasError = false;
                let errorMsg = '';

                results.forEach((data, index) => {
                    if (data.error) {
                        hasError = true;
                        errorMsg = data.error;
                    } else {
                        validResults.push({
                            stock: stocks[index],
                            data: data
                        });
                    }
                });

                if (hasError) {
                    resultsDiv.innerHTML = `<div class="p-4 bg-red-50 border-l-4 border-red-400"><p class="font-semibold text-red-800">Error Fetching Data</p><p class="text-sm text-red-600">${errorMsg}</p></div>`;
                    return;
                }

                // Calculate Portfolio Returns
                // Find common date range (intersection of dates)
                let commonDates = Object.keys(validResults[0].data.dailyPrices).sort();

                // Intersect with other stocks
                for (let i = 1; i < validResults.length; i++) {
                    const stockDates = new Set(Object.keys(validResults[i].data.dailyPrices));
                    commonDates = commonDates.filter(d => stockDates.has(d));
                }

                // Need at least 2 days to calculate return
                if (commonDates.length < 2) {
                     resultsDiv.innerHTML = '<p class="text-red-500">Not enough common trading data found to calculate portfolio metrics.</p>';
                     return;
                }

                // Calculate daily returns for each stock and portfolio
                const portfolioDailyReturns = [];
                // Start from index 1 (second oldest date) to calculate return from previous day
                for (let i = 1; i < commonDates.length; i++) {
                    const today = commonDates[i];
                    const yesterday = commonDates[i-1];
                    let dailyPortfolioReturn = 0;

                    validResults.forEach(item => {
                        const priceToday = item.data.dailyPrices[today];
                        const priceYesterday = item.data.dailyPrices[yesterday];
                        const stockReturn = (priceToday - priceYesterday) / priceYesterday;
                        const weight = item.stock.weight / totalWeight; // Normalize weight
                        dailyPortfolioReturn += stockReturn * weight;
                    });
                    portfolioDailyReturns.push(dailyPortfolioReturn);
                }

                // Calculate Metrics
                const meanDailyReturn = portfolioDailyReturns.reduce((sum, r) => sum + r, 0) / portfolioDailyReturns.length;

                // Standard Deviation
                const variance = portfolioDailyReturns.reduce((sum, r) => sum + Math.pow(r - meanDailyReturn, 2), 0) / (portfolioDailyReturns.length - 1);
                const stdDev = Math.sqrt(variance);

                // Annualize (assuming 252 trading days)
                const annualizedVolatility = stdDev * Math.sqrt(252) * 100; // in percent
                const annualizedReturn = meanDailyReturn * 252 * 100; // in percent

                // Total Return over the period (Cumulative)
                const startPriceDate = commonDates[0];
                const endPriceDate = commonDates[commonDates.length - 1];
                let portfolioCumulativeReturn = 0;

                validResults.forEach(item => {
                    const startPrice = item.data.dailyPrices[startPriceDate];
                    const endPrice = item.data.dailyPrices[endPriceDate];
                    const stockReturn = (endPrice - startPrice) / startPrice;
                    portfolioCumulativeReturn += stockReturn * (item.stock.weight / totalWeight);
                });
                portfolioCumulativeReturn *= 100;

                // Render Results
                let resultsHTML = '<h3 class="text-2xl font-bold text-gray-800 mb-4">Portfolio Analysis</h3>';
                resultsHTML += `<p class="text-sm text-gray-500 mb-4">Analysis based on data from ${startPriceDate} to ${endPriceDate} (${commonDates.length} trading days).</p>`;

                resultsHTML += '<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">';
                // Total Return Card
                resultsHTML += `
                    <div class="p-4 bg-white border rounded shadow-sm">
                        <p class="text-gray-500 text-sm font-bold uppercase">Total Return</p>
                        <p class="text-2xl font-bold ${portfolioCumulativeReturn >= 0 ? 'text-green-600' : 'text-red-600'}">${portfolioCumulativeReturn.toFixed(2)}%</p>
                    </div>
                `;
                // Annualized Volatility Card
                resultsHTML += `
                    <div class="p-4 bg-white border rounded shadow-sm">
                        <p class="text-gray-500 text-sm font-bold uppercase">Annualized Volatility</p>
                        <p class="text-2xl font-bold text-gray-800">${annualizedVolatility.toFixed(2)}%</p>
                    </div>
                `;
                // Annualized Return (Est) Card
                 resultsHTML += `
                    <div class="p-4 bg-white border rounded shadow-sm">
                        <p class="text-gray-500 text-sm font-bold uppercase">Est. Annual Return</p>
                        <p class="text-2xl font-bold ${annualizedReturn >= 0 ? 'text-green-600' : 'text-red-600'}">${annualizedReturn.toFixed(2)}%</p>
                    </div>
                `;
                resultsHTML += '</div>';

                resultsHTML += '<h4 class="text-lg font-bold text-gray-800 mb-3">Individual Stock Performance</h4>';
                resultsHTML += '<div class="space-y-4">';

                validResults.forEach(item => {
                    const startPrice = item.data.dailyPrices[startPriceDate];
                    const endPrice = item.data.dailyPrices[endPriceDate];
                    const performance = ((endPrice - startPrice) / startPrice) * 100;

                    resultsHTML += `
                        <div class="p-4 bg-gray-50 rounded-lg border">
                            <div class="flex justify-between items-center">
                                <p class="text-lg font-bold text-gray-900">${item.stock.ticker} <span class="text-sm font-normal text-gray-600">(${item.stock.weight} alloc)</span></p>
                                <p class="text-lg font-bold ${performance >= 0 ? 'text-green-500' : 'text-red-500'}">${performance.toFixed(2)}%</p>
                            </div>
                            <div class="text-sm text-gray-600 mt-2">
                                <p>Start Price: $${startPrice.toFixed(2)}</p>
                                <p>End Price: $${endPrice.toFixed(2)}</p>
                            </div>
                        </div>
                    `;
                });
                resultsHTML += '</div>';

                resultsDiv.innerHTML = resultsHTML;

                // Update Chart
                chartContainer.style.display = 'block';
                // Small delay to ensure container is visible and layout updated before chart render if needed
                setTimeout(() => {
                    initChart();
                    if (frontierChart) {
                        frontierChart.data.datasets[0].data.push({
                            x: annualizedVolatility,
                            y: annualizedReturn,
                            composition: stocks.map(s => ({
                                ticker: s.ticker,
                                weight: (s.weight / totalWeight * 100).toFixed(1)
                            }))
                        });
                        frontierChart.update();
                    }
                }, 100);


            } catch (error) {
                resultsDiv.innerHTML = `<p class="text-red-500">An unexpected error occurred: ${error.message}</p>`;
            }
        });

        async function fetchData(ticker, apiKey) {
            try {
                // Fetch daily series
                const response = await fetch(`https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${ticker}&apikey=${apiKey}`);
                const data = await response.json();

                if (data['Note']) {
                    return { error: 'API rate limit reached. Please wait a minute and try again.' };
                }
                if (data['Error Message']) {
                     return { error: `Invalid ticker: ${ticker}` };
                }
                if (!data['Time Series (Daily)']) {
                    return { error: 'No data available.' };
                }

                const timeSeries = data['Time Series (Daily)'];
                // Get last 30 trading days (or less if not available)
                const dates = Object.keys(timeSeries).sort();
                dates.sort((a, b) => new Date(a).getTime() - new Date(b).getTime());

                const recentDates = dates.slice(-30);

                const dailyPrices = {};
                recentDates.forEach(date => {
                    dailyPrices[date] = parseFloat(timeSeries[date]['4. close']);
                });

                return {
                    dailyPrices: dailyPrices
                };
            } catch (e) {
                return { error: 'Failed to fetch data. Check your network connection.' };
            }
        }
    });
  </script>
</Layout>
