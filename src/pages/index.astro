---
import Layout from "../layouts/MainLayout.astro";
---

<Layout>
    <div class="bg-white p-6 md:p-8 rounded-lg shadow-lg">
        <div
            id="image-carousel"
            class="relative rounded-lg overflow-hidden shadow-inner"
            style="height: 500px"
        >
            <div
                class="carousel-slide absolute top-0 left-0 w-full h-full opacity-100"
            >
                <img
                    src="/assets/carousel/alpaca.jpg"
                    class="w-full h-full object-cover"
                    alt="Alpaca farm event"
                />
            </div>
            <div
                class="carousel-slide absolute top-0 left-0 w-full h-full opacity-0"
            >
                <img
                    src="/assets/carousel/rainbow.jpg"
                    class="w-full h-full object-cover"
                    alt="Rainbow color shirts"
                />
            </div>
            <div
                class="carousel-slide absolute top-0 left-0 w-full h-full opacity-0"
            >
                <img
                    src="/assets/carousel/formal.jpg"
                    class="w-full h-full object-cover"
                    alt="Formal wear photo"
                />
            </div>
            <div
                class="carousel-slide absolute top-0 left-0 w-full h-full opacity-0"
            >
                <img
                    src="/assets/carousel/diwali.jpg"
                    class="w-full h-full object-cover"
                    alt="Diwali celebration"
                />
            </div>
            <button
                id="carousel-prev"
                class="absolute top-1/2 left-4 -translate-y-1/2 bg-black/30 text-white rounded-full p-2 hover:bg-black/50 transition z-10"
            >
                <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <button
                id="carousel-next"
                class="absolute top-1/2 right-4 -translate-y-1/2 bg-black/30 text-white rounded-full p-2 hover:bg-black/50 transition z-10"
            >
                <svg
                    class="w-6 h-6"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 5l7 7-7 7"></path>
                </svg>
            </button>
            <div
                id="carousel-dots"
                class="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-2 z-10"
            >
                <button
                    class="carousel-dot w-3 h-3 bg-white/50 rounded-full transition"
                ></button>
                <button
                    class="carousel-dot w-3 h-3 bg-white/50 rounded-full transition"
                ></button>
                <button
                    class="carousel-dot w-3 h-3 bg-white/50 rounded-full transition"
                ></button>
                <button
                    class="carousel-dot w-3 h-3 bg-white/50 rounded-full transition"
                ></button>
            </div>
        </div>

        <div class="mt-12">
            <h2 class="text-3xl font-bold mb-6 text-gray-800">Announcements</h2>
            <div id="announcements-container" class="space-y-6">
                <p class="text-gray-600">Loading announcements...</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const carousel = document.getElementById("image-carousel");
            if (carousel) {
                // ... (all your existing carousel JS) ...
                const slides = carousel.querySelectorAll(".carousel-slide");
                const dots = carousel.querySelectorAll(".carousel-dot");
                const prevButton = document.getElementById("carousel-prev");
                const nextButton = document.getElementById("carousel-next");
                let currentSlide = 0;
                const totalSlides = slides.length;
                let autoSlideInterval;
                function updateCarousel(newIndex) {
                    if (newIndex < 0) {
                        newIndex = totalSlides - 1;
                    } else if (newIndex >= totalSlides) {
                        newIndex = 0;
                    }
                    slides[currentSlide].classList.add("opacity-0");
                    dots[currentSlide].classList.add("bg-white/50");
                    dots[currentSlide].classList.remove("bg-white");
                    slides[newIndex].classList.remove("opacity-0");
                    dots[newIndex].classList.remove("bg-white/50");
                    dots[newIndex].classList.add("bg-white");
                    currentSlide = newIndex;
                }
                function nextSlide() {
                    updateCarousel(currentSlide + 1);
                }
                function prevSlide() {
                    updateCarousel(currentSlide - 1);
                }
                function startAutoSlide() {
                    autoSlideInterval = setInterval(nextSlide, 5000);
                }
                function stopAutoSlide() {
                    clearInterval(autoSlideInterval);
                }
                nextButton.addEventListener("click", () => {
                    nextSlide();
                    stopAutoSlide();
                    startAutoSlide();
                });
                prevButton.addEventListener("click", () => {
                    prevSlide();
                    stopAutoSlide();
                    startAutoSlide();
                });
                dots.forEach((dot, index) => {
                    dot.addEventListener("click", () => {
                        updateCarousel(index);
                        stopAutoSlide();
                        startAutoSlide();
                    });
                });
                updateCarousel(0);
                startAutoSlide();
            }
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // These are from your *original* sheet URL
            const SPREADSHEET_ID =
                "12MC157YYPrQjbj1a17Z1nwNfUJMNRXTFOQvU6_DBHQs";
            const SHEET_GID = "0";

            const JSON_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_GID}`;
            const container = document.getElementById(
                "announcements-container",
            );

            async function fetchAnnouncements() {
                try {
                    const response = await fetch(JSON_URL);
                    if (!response.ok) {
                        throw new Error("Network response was not ok");
                    }
                    let text = await response.text();

                    // The response is JSONP, not pure JSON. We need to clean it.
                    // It starts with 'google.visualization.Query.setResponse(' and ends with ');'
                    const jsonText = text.substring(47, text.length - 2);
                    const data = JSON.parse(jsonText);

                    // The actual data is in data.table.rows
                    // c: is an array of columns
                    // v: is the value
                    const announcements = data.table.rows
                        .map((row) => ({
                            Title: row.c[0] ? row.c[0].v : null,
                            Description: row.c[1] ? row.c[1].v : null,
                            Link: row.c[2] ? row.c[2].v : null,
                        }))
                        .filter((item) => item.Title); // Filter out empty rows

                    // Clear the "Loading..." message
                    container.innerHTML = "";

                    if (announcements.length > 0) {
                        announcements.forEach((item) => {
                            // Create the link HTML (if a link exists)
                            const linkHtml = item.Link
                                ? `<a
                    href="${item.Link}"
                    class="inline-block text-blue-600 font-medium hover:underline transition-colors"
                    target="_blank"
                    rel="noopener noreferrer"
                  >
                    Learn More &rarr;
                  </a>`
                                : ""; // Empty string if no link

                            // Replace newlines (\n) with <br> tags for HTML rendering
                            const descriptionHtml = item.Description.replace(
                                /\n/g,
                                "<br />",
                            );

                            const articleHtml = `
                <article class="bg-gray-50 border border-gray-200 rounded-lg p-6 shadow-sm">
                  <h3 class="text-xl font-semibold text-gray-900 mb-2">${item.Title}</h3>
                  <p class="text-gray-700 mb-4">
                    ${descriptionHtml}
                  </p>
                  ${linkHtml}
                </article>
              `;

                            container.innerHTML += articleHtml;
                        });
                    } else {
                        container.innerHTML =
                            '<p class="text-gray-600">No announcements at this time.</p>';
                    }
                } catch (error) {
                    console.error("Error fetching announcements:", error);
                    container.innerHTML =
                        '<p class="text-red-600">Failed to load announcements. Please try refreshing the page.</p>';
                }
            }

            // Call the function to fetch and render
            fetchAnnouncements();
        });
    </script>
</Layout>
